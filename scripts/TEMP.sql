CREATE OR REPLACE PROCEDURE DC@RNSLIB.SP_CONSULTA_JNTAOPEIMPO ( 
IN @DESDE VARCHAR(8),
IN @HASTA VARCHAR(8)
) 
	DYNAMIC RESULT SETS 1 
	LANGUAGE SQL 
	SPECIFIC DC@RNSLIB.SP_CONSULTA_JNTAOPEIMPO 
	NOT DETERMINISTIC 
	MODIFIES SQL DATA 
	CALLED ON NULL INPUT 
	SET OPTION  ALWBLK = *ALLREAD , 
	ALWCPYDTA = *OPTIMIZE , 
	COMMIT = *NONE , 
	DECRESULT = (31, 31, 00) , 
	DFTRDBCOL = QGPL , 
	DYNDFTCOL = *NO , 
	DYNUSRPRF = *USER , 
	SRTSEQ = *HEX   
	BEGIN 
DECLARE STRSQL VARCHAR ( 5000 ) ; 
DECLARE CU_01 CURSOR WITH RETURN FOR S1 ; 
SET STRSQL ='SELECT 
R22.NORSRN,
R22.CVPRCN,
RK08.TCMPVP,
R22.NVJES,
R22.CTPOOP,
R22.CVSTR1,
R22.AMNFS,
R22.NMNFEN,
R22.CCMPTR,
R22.CLNNSS,
R22.CPRLLN,
R24.CPRCN3,
R24.NSRCN3,
CONCAT(R24.CPRCN3,R24.NSRCN3) AS CONTENE,
R24.CTPCR1,
R24.CCLBLM,
SUM(R24.NBLRCR) AS NBLRCR,
SUM(R24.QPBRCR) AS QPBRCR,
R24.SPRPRP,
R25.TTMNCN1,
R25.SCNRFG,
R25.CTPOC2,
COUNT(R24.NCNEM1) AS CANTCONO,
CASE  R25.CTPCNI
  WHEN ''E'' THEN   ''SI''
  ELSE ''NO'' END AS EXCLUSIVO,
IFNULL(RE07.FINDSC,R22.FLLGNV) AS FINDSC,
RE07.FFNDSC,
RE07.HFNDSC,
 CASE RW05.FLGOPP
WHEN ''D'' THEN ''DPW''
WHEN ''A'' THEN ''APM''
ELSE ''''
END AS FLGOPP
FROM "DC@RNSLIB".RZIT22 R22
LEFT JOIN DC@RNSLIB.RZIT24 R24 ON R22.NORSRN = R24.NORSRN AND R24.SESTRG =''A''  
LEFT JOIN DC@RNSLIB.RZIT25 R25 ON R22.NORSRN = R25.NORSRN AND R24.CPRCN3 = R25.CPRCN4 AND R24.NSRCN3 = R25.NSRCN4 AND R25.SESTRG !=''*''
LEFT JOIN DC@RNSLIB.RZET08 RE08 ON R22.NORSRN = RE08.NORSRN 
LEFT JOIN DC@RNSLIB.RZET07 RE07 ON RE08.NMRLQO = RE07.NMRLQO
LEFT JOIN DC@RNSLIB.RZZK08 RK08 ON R22.CVPRCN = RK08.CVPRCN
LEFT JOIN DC@RNSLIB.RZTW05 RW05 ON R22.NORSRN = RW05.NORSRN
WHERE R22.SESTRG = ''A'' 
AND R22.CTPOOP = 1 AND R22.FLLGNV BETWEEN '||@DESDE||' AND ' || @HASTA ||'
GROUP BY
R22.NORSRN,
R22.CVPRCN,
RK08.TCMPVP,
R22.NVJES,
R22.CTPOOP,
R22.CVSTR1,
R22.AMNFS,
R22.NMNFEN,
R22.CCMPTR,
R22.CLNNSS,
R22.CPRLLN,
R24.CPRCN3,
R24.NSRCN3,
R24.CTPCR1,
R24.CCLBLM,
--R24.NBLRCR,
--R24.QPBRCR,
R24.SPRPRP,
R25.TTMNCN1,
R25.SCNRFG,
R25.CTPOC2,
RE07.FFNDSC,
RE07.HFNDSC,
IFNULL(RE07.FINDSC,R22.FLLGNV),
CASE  R25.CTPCNI
  WHEN ''E'' THEN   ''SI''
  ELSE ''NO'' END,
 CASE RW05.FLGOPP
WHEN ''D'' THEN ''DPW''
WHEN ''A'' THEN ''APM''
ELSE ''''
END
  ORDER BY RK08.TCMPVP, R24.CPRCN3, R24.NSRCN3';


PREPARE S1 FROM STRSQL ; 
OPEN CU_01 ; 
  
END  ;